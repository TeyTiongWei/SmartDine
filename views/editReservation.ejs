<%- contentFor('title') %>
Edit Reservation

<%- contentFor('css') %>

<%- contentFor('body') %>
<!-- Main content goes here -->
<div class="mb-4">
    <h1 class="fw-bold mb-0">Edit Reservation</h1>
    <p class="text-secondary fs-4">Modify a customer's existing reservation</p>
</div>
<div class="border border-2 rounded-4 px-5 py-4">
    <form action="/editReservation/<%= reservation.id %>" method="POST" class="needs-validation" novalidate>
        <div class="col-12">
            <div class="row g-4 mb-4">
                <div class="col-lg-6">
                    <label for="customerName" class="form-label fw-medium">Customer Name</label>
                    <input type="text" class="form-control" id="customerName" name="customerName" placeholder="Enter Customer's Full Name" 
                        value="<%= reservation.customer_name %>" required autofocus>
                        <div class="invalid-feedback">
                            Please enter a valid customer name.
                        </div>
                </div>
                <div class="col-lg-6">
                    <label for="partySize" class="form-label fw-medium">Party Size</label>
                    <input type="number" class="form-control" id="partySize" name="partySize" placeholder="Number of guests" min="1" max="8"
                        value="<%= reservation.party_size %>" required>
                        <div class="invalid-feedback">
                            Party Size must be between 1 - 8 guests.
                        </div>
                </div>
            </div>
        </div>
        <div class="col-12">
            <div class="row g-4 mb-4">
                <div class="col-lg-6">
                    <label for="phoneNumber" class="form-label fw-medium">Phone Number</label>
                    <input type="tel" class="form-control" id="phoneNumber" name="phoneNumber" placeholder="0123456789"
                        value="<%= reservation.phone_number %>" required>
                        <div class="invalid-feedback">
                            Please enter a valid phone number.
                        </div>
                </div>
                <div class="col-lg-6">
                    <label for="tableNumber" class="form-label fw-medium">Table Number</label>
                    <select class="form-select" id="tableNumber" name="tableNumber" required>
                        <option selected disabled value="">Select a Table</option>
                        <% tables.forEach((table) => { %>
                            <option value="<%= table.table_number %>" data-capacity="<%= table.capacity %>"
                                <%= reservation.table_number === table.table_number ? 'selected' : '' %>>
                                <%= table.table_number %> (Max: <%= table.capacity %> People)
                            </option>
                        <% }) %>
                    </select>
                        <div class="invalid-feedback">
                            Please select a table.
                        </div>
                </div>
            </div>
        </div>
        <div class="col-12">
            <div class="row g-4 mb-4">
                <div class="col-lg-6">
                    <label for="email" class="form-label fw-medium">Email Address</label>
                    <input type="email" class="form-control" id="email" name="email" placeholder="customer@gmail.com"
                        value="<%= reservation.email %>" required>
                        <div class="invalid-feedback">
                            Please enter a valid email.
                        </div>
                </div>
                <div class="col-lg-6">
                    <label for="reservationDate" class="form-label fw-medium">Reservation Date</label>
                    <input type="date" class="form-control" id="reservationDate" name="reservationDate" placeholder="Select a Date" min=""
                        value="<%= reservation.reservation_date %>" required>
                        <div class="invalid-feedback">
                            Please choose a valid reservation date.
                        </div>
                </div>
            </div>
        </div>
        <div class="col-12">
            <div class="row g-4 mb-4">
                <div class="col-lg-6">
                    <label for="specialRequests" class="form-label fw-medium">Special Requests (Optional)</label>
                    <input type="text" class="form-control" id="specialRequests" name="specialRequests" placeholder="Any special accommodations or requests"
                        value="<%= reservation.special_requests %>">
                </div>
                <div class="col-lg-6">
                    <label for="reservationTime" class="form-label fw-medium">Reservation Time</label>
                    <input type="time" class="form-control" id="reservationTime" name="reservationTime" placeholder="Select a Time"
                        value="<%= reservation.reservation_time %>" required>
                        <div class="invalid-feedback">
                            Please choose a valid reservation time.
                        </div>
                </div>
            </div>
        </div>
        <div class="col-12">
            <div class="row g-2 mb-3 mt-4">
                <% if (error && error.length > 0) { %>
                    <p class="text-danger text-center fw-semibold mb-3">
                        <%= error %>
                    </p>
                <% } %>
                <div class="col-lg-3">
                    <button type="submit" formaction="/editReservation/<%= reservation.id %>?_method=PATCH" class="btn btn-lg btn-danger w-100 fw-semibold">Cancel Reservation</button>
                </div>
                <div class="col-lg-2 offset-lg-4">
                    <a href="/viewReservations" class="btn btn-lg btn-secondary w-100 fw-semibold">Back</a>
                </div>
                <div class="col-lg-3">
                    <button type="submit" class="btn btn-lg btn-primary w-100 fw-semibold">Save Changes</button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    const partySizeInput = document.getElementById("partySize");
    const tableSelect = document.getElementById("tableNumber");

    // Store all the table options (except the first "Select a Table")
    const allOptions = Array.from(tableSelect.querySelectorAll("option[data-capacity]"));

    partySizeInput.addEventListener("input", () => {
        const size = parseInt(partySizeInput.value);

        // Always reset dropdown back to default
        tableSelect.innerHTML = '<option selected disabled value="">Select a Table</option>';

        // Filter tables that can fit the entered party size
        const filtered = allOptions.filter(opt => parseInt(opt.dataset.capacity) >= size);

        // Add only the filtered options back
        filtered.forEach(opt => tableSelect.appendChild(opt));

        // Reset selection visually too
        tableSelect.selectedIndex = 0;
    });

    // Prevent user from selecting past dates
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("reservationDate").setAttribute("min", today);
</script>